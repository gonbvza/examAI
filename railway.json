{
    "build": {
      "builder": "nixpacks",
      "nixpacksPlan": {
        "phases": {
          "setup": {
            "aptPkgs": ["python3", "python3-pip", "python3-venv", "build-essential", "postgresql-client"]
          },
          "install": {
            "cmds": [
              "python3 -m venv /venv",
              "source /venv/bin/activate",
              "pip install --upgrade pip",
              "npm install --save-exact react react-dom @types/react@18.2.0 @types/react-dom@18.2.0 react-router-dom @fortawesome/react-fontawesome @fortawesome/free-solid-svg-icons @fortawesome/fontawesome-svg-core react-modal @types/react-modal js-cookie @types/js-cookie",
              "npm install -g concurrently",
              "npm run build --prefix client",
              "cd server/server/ && pip install -r requirements.txt",
              "echo '#!/bin/bash' > start.sh",
              "echo 'source /venv/bin/activate' >> start.sh",
              "echo '' >> start.sh",
              "echo '# Extract database connection details from DATABASE_URL' >> start.sh",
              "echo 'if [ -n \"$DATABASE_URL\" ]; then' >> start.sh",
              "echo '  echo \"Extracting connection details from DATABASE_URL\"' >> start.sh",
              "echo '  # Parse the DATABASE_URL to get the host and port' >> start.sh",
              "echo '  DB_HOST=$(echo $DATABASE_URL | sed -n \"s/.*@\\([^:]*\\).*/\\1/p\")' >> start.sh",
              "echo '  DB_PORT=$(echo $DATABASE_URL | sed -n \"s/.*:\\([0-9]*\\)\\/.*/\\1/p\")' >> start.sh",
              "echo '  echo \"Found DB_HOST=$DB_HOST and DB_PORT=$DB_PORT\"' >> start.sh",
              "echo '  ' >> start.sh",
              "echo '  # Wait for PostgreSQL to be ready' >> start.sh",
              "echo '  echo \"Waiting for PostgreSQL to be ready...\"' >> start.sh",
              "echo '  for i in {1..120}; do' >> start.sh",
              "echo '    if pg_isready -h \"$DB_HOST\" -p \"$DB_PORT\"; then' >> start.sh",
              "echo '      echo \"PostgreSQL is up and running!\"' >> start.sh",
              "echo '      break' >> start.sh",
              "echo '    fi' >> start.sh",
              "echo '    if [ $i -eq 120 ]; then' >> start.sh",
              "echo '      echo \"PostgreSQL connection timed out after 2 minutes\"' >> start.sh",
              "echo '    else' >> start.sh",
              "echo '      echo \"PostgreSQL is unavailable - sleeping (attempt $i/120)\"' >> start.sh",
              "echo '      sleep 1' >> start.sh",
              "echo '    fi' >> start.sh",
              "echo '  done' >> start.sh",
              "echo 'fi' >> start.sh",
              "echo '' >> start.sh",
              "echo '# Run migrations' >> start.sh",
              "echo 'cd server/server/ && python manage.py migrate' >> start.sh",
              "echo '' >> start.sh",
              "echo '# Start frontend' >> start.sh",
              "echo 'cd ../../client && npm run preview -- --host 0.0.0.0 --port \"$PORT\" &' >> start.sh",
              "echo 'FRONTEND_PID=$!' >> start.sh",
              "echo '' >> start.sh",
              "echo '# Start backend' >> start.sh",
              "echo 'cd ../server/server/ && pyhton -m pip install -r requirements.txt && python -m gunicorn serverDjango.wsgi:application --bind 0.0.0.0:8000 --workers 3 &' >> start.sh",
              "echo 'BACKEND_PID=$!' >> start.sh",
              "echo '' >> start.sh",
              "echo '# Wait for either process to exit' >> start.sh",
              "echo 'wait $FRONTEND_PID $BACKEND_PID' >> start.sh",
              "chmod +x start.sh"
            ]
          }
        }
      }
    },
    "deploy": {
      "startCommand": "./start.sh",
      "restartPolicyType": "ON_FAILURE",
      "restartPolicyMaxRetries": 10,
      "healthcheckPath": "/",
      "healthcheckTimeout": 300,
      "env": {
        "DJANGO_SECRET_KEY": "django-insecure-railway-deployment-key-should-be-changed",
        "DEBUG": "False",
        "DJANGO_LOGLEVEL": "info",
        "DJANGO_ALLOWED_HOSTS": ".railway.app",
        "PORT": "3000",
        "DATABASE_URL": "${{ Postgres.DATABASE_URL }}"
      }
    },
    "plugins": {
      "postgresql": {
        "version": "17"
      }
    }
  }